#include "DHT.h"

// Setup buffer size for receiving data
#define CMDBUFFER_SIZE 120

//Setup for the temperature sensor DHT11
#define tempProbe 2
#define DHTTYPE DHT11
DHT dht(tempProbe, DHTTYPE);

// Setup for ground floor light control pin
#define denTangtret 8

boolean toggle1 = 0;

// Define function using in the program

void setupUDP();
void serialEvent();
char processCharInput();
char processReceiveMessage();
String getStringPart();
void guiNhietdo();
void guiDoam();
void sendPacket();
float tempget();
float humiget();

void setup()
{
  /*----------------------------------------------
  ---------SET UP TIMER 1 TIMER INTERRUPT---------
  -----------------------------------------------*/
  cli(); //stop interrupts
    //set timer1 interrupt at 1Hz
    TCCR0A = 0; // set entire TCCR1A register to 0
    TCCR0B = 0; // same for TCCR1B
    TCNT0 = 0;  //initialize counter value to 0
    // set compare match register for 1hz increments
    OCR0A = 15624; // = (16*10^6) / (1*1024) - 1 (must be <65536)
    // turn on CTC mode
    TCCR0B |= (1 << WGM12);
    // Set CS10 and CS12 bits for 1024 prescaler
    TCCR0B |= (1 << CS12) | (1 << CS10);
    // enable timer compare interrupt
    TIMSK0 |= (1 << OCIE1A);
  sei(); //allow interrupts

  Serial.begin(115200);
  dht.begin();
  pinMode(denTangtret, OUTPUT); // set pin to output
  delay(1000);
  setupUDP();
}

/*----------------------------------------------
-----SET UP SENDING DATA TEMP AND HUMIDITY------
-----------------------------------------------*/

ISR(TIMER0_COMPA_vect)
{ //timer1 interrupt 1Hz toggles pin 13 (LED)
  //generates pulse wave of frequency 1Hz/2 = 0.5kHz (takes two cycles for full wave- toggle high then toggle low)
  if (toggle1)
  {
    if (tempget() != 0x00)
    {
      guiNhietdo();
    }
    toggle1 = 0;
  }
  else
  {
    if (humiget() != 0x00)
    {
      guiDoam();
    }
    toggle1 = 1;
  }
}

void loop()
{
  while (!Serial)
  {
    //wait for serial port to connect.
  }
}



/*----------------------------------------------
---------SET UP MODULE CC2538 FUNCTIONS---------
-----------------------------------------------*/

void setupUDP()
{
  Serial.println("udp open");
  delay(100);
  Serial.println("udp bind :: 1212");
  delay(100);
}

/*----------------------------------------------
-------RECEIVE AND PROCESSING ARRIVAL DATA------
-----------------------------------------------*/

void serialEvent()
{
  static char cmdBuffer[CMDBUFFER_SIZE] = "";
  String packet, data;
  char c, dataChuoi[30];
  while (Serial.available())
  {
    c = processCharInput(cmdBuffer, Serial.read());
    // Serial.print(c);
    if (c == '\n')
    {
      // Serial.println();
      //Full command received. Do your stuff here!
      packet = String(cmdBuffer);
      char space = ' ';
      data = getStringPart(packet, space, 5);
      // Serial.print("Data nhan duoc: ");
      // Serial.println(data);
      // Serial.println();
      data.toCharArray(dataChuoi, 30);
      if (strcmp("groundfloor/light_ON", dataChuoi) == 0)
      {
        // Serial.println("Da mo den tang tret");
        digitalWrite(denTangtret, HIGH);
      }
      if (strcmp("groundfloor/light_OFF", dataChuoi) == 0)
      {
        // Serial.println("Da tat den tang tret");
        digitalWrite(denTangtret, LOW);
      }

      cmdBuffer[0] = 0;
    }
  }
  delay(1);
}

char processCharInput(char *cmdBuffer, const char c)
{
  //Store the character in the input buffer
  if (c >= 32 && c <= 126) //Ignore control characters and special ascii characters
  {
    if (strlen(cmdBuffer) < CMDBUFFER_SIZE)
    {
      strncat(cmdBuffer, &c, 1); //Add it to the buffer
    }
    else
    {
      return '\n';
    }
  }
  else if ((c == 8 || c == 127) && cmdBuffer[0] != 0) //Backspace
  {

    cmdBuffer[strlen(cmdBuffer) - 1] = 0;
  }

  return c;
}

char processReceiveMessage(char *packet)
{
  /*
  Usage: return the message data embedded in the packet
  */
  int pointer = 5;
  int i = 0;
  char buffer[30];
  while (pointer > 0)
  {
    if (packet[i] == ' ') //if appeare a ' ' in sentence reduce pointer => enter a new word
    {
      pointer = pointer - 1; //decrease pointer by 1 to get to value 0
    }
    i = i + 1; //increase i to go to next charactor
  }
  if (pointer == 0)
  {
    int j = 0;
    while ((i < strlen(packet)))
    {
      buffer[j] = packet[i];
      i++;
      j++;
    }
  }
  return buffer;
}

// splitting a string and return the part index split by separator
String getStringPart(String data, char separator, int index)
{
  int stringData = 0;   //variable to count data part
  String dataPart = ""; //variable to hole the return text

  for (int i = 0; i < data.length(); i++)
  { //Walk through the text one letter at a time
    if (data[i] == separator)
    {
      //Count the number of times separator character appears in the text
      stringData++;
    }
    else if (stringData == index)
    {
      //get the text when separator is the rignt one
      dataPart.concat(data[i]);
    }
    else if (stringData > index)
    {
      //return text and stop if the next separator appears - to save CPU-time
      return dataPart;
      break;
    }
  }
  //return text if this is the last part
  return dataPart;
}

/*----------------------------------------------
-----SEND DATA TO THREAD NETWORK FUNCTIONS------
-----------------------------------------------*/

void guiNhietdo()
{
  float nhietdo = tempget();
  String nhietdoChuoi = "temp_";
  nhietdoChuoi = nhietdoChuoi + nhietdo;
  char chuoiXuat[15];
  nhietdoChuoi.toCharArray(chuoiXuat, 15);
  nhietdoChuoi = "";
  sendPacket(chuoiXuat);
}

void guiDoam()
{
  /*
  Function: send humidity data read from DHT11 sensor to CC2538 via physical UART port
  Usage: guiDoam();
  */
  float doam = humiget();
  String doamChuoi = "doam1_";
  doamChuoi = doamChuoi + doam;
  // doamChuoi = "doam_36.23";
  char chuoiXuat[12];
  doamChuoi.toCharArray(chuoiXuat, 12);
  doamChuoi = "";
  sendPacket(chuoiXuat);
}

void sendPacket(char *message)
{
  /*
  Function: send mesage to multicast address at port 1212
  Usage: sendPacket("doam1_60.23")
    */
  Serial.print("udp send ff03::1 1212 ");
  Serial.println(message);
}

/*----------------------------------------------
--DHT11 TEMPERATURE, HUMIDITY SENSOR FUNCTIONS--
-----------------------------------------------*/

float tempget()
{
  float temp = dht.readTemperature();
  if (isnan(temp))
  {
    temp = 0x00;
  }
  return temp;
}

float humiget()
{
  float humi = dht.readHumidity();
  if (isnan(humi))
  {
    humi = 0x00;
  }
  return humi;
}